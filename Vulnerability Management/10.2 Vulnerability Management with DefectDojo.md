# Vulnerability Management with DefectDojo
Learn how to use Defect Dojo to manage vulnerabilities
## Download the source code
First, we need to download the source code of the project from our git repository.
```sh
git clone https://gitlab.practical-devsecops.training/pdso/django.nv webapp
cd webapp
```
## Install Bandit
The Bandit is a tool designed to find common security issues in Python code.
To do this Bandit, processes each file, builds an AST, and runs appropriate plugins against the AST nodes. Once Bandit has finished scanning all the files it generates a report.
Bandit was originally developed within the OpenStack Security Project and later rehomed to PyCQA.
```
pip3 install bandit==1.7.1
```
## Run the scanner
As we have learned in the DevSecOps Gospel, we would like to store the tool results in a JSON file. We are using the tee command here to show the output and store it in a file simultaneously.
```sh
bandit -r . -f json | tee bandit-output.json
```
Bandit ran successfully, and it found three security issues.
1. One high severity issue
2. One medium severity issue
3. One low severity issue

Let’s upload this file to DefectDojo in the next step.
## Upload the results to DefectDojo
DefectDojo provides an API to upload the scan results, and this is an excellent feature for uploading scan results during CI/CD process. We have created a simple upload script for you, and you can download this script using the following command.
```sh
curl https://gitlab.practical-devsecops.training/-/snippets/3/raw -o upload-results.py
```
Let’s explore what options it provides us.
```sh
python3 upload-results.py --help
```
```
**Output**
usage: upload-results.py [-h] --host HOST --api_key API_KEY --engagement_id
                         ENGAGEMENT_ID --result_file RESULT_FILE --scanner
                         SCANNER --product_id PRODUCT_ID --lead_id LEAD_ID
                         [--build_id BUILD_ID]

CI/CD integration for DefectDojo

optional arguments:
  -h, --help            show this help message and exit
  --host HOST           DefectDojo Hostname
  --api_key API_KEY     API v2 Key
  --engagement_id ENGAGEMENT_ID
                        Engagement ID
  --result_file RESULT_FILE
                        Scanner file
  --scanner SCANNER     Type of scanner
  --product_id PRODUCT_ID
                        DefectDojo Product ID
  --lead_id LEAD_ID     ID of the user conducting the testing
  --environment ENVIRONMENT
                        Environment name
  --build_id BUILD_ID   Reference to external build id
```
We need to provide the following inputs for this script to work.
Name	Value
|Name|Value|
|:---|:----|
|Host|https://dojo-acsrq8h9.lab.practical-devsecops.training|
|Username|root|
|API_Key|Find it at https://dojo-acsrq8h9.lab.practical-devsecops.training/api/key-v2|
|Engagement_ID|ID of the engagement, here its 1|
|Product_ID|ID of product, here its 1|
|Lead_ID|ID of the user conducting the testing|
|Environment|Environment name|
|Scanner|Name of the scanner, this is case sensitive e.g., ZAP Scan, Bandit Scan, etc|
|Result_File|The path to the tool’s output|

You can copy the API_KEY from the DefectDojo app and replace INSERT_API_KEY_HERE with the API_KEY in the below command.
You can also use the following command to get a token programmatically.
```sh
export API_KEY=$(curl -s -XPOST -H 'content-type: application/json' https://dojo-acsrq8h9.lab.practical-devsecops.training/api/v2/api-token-auth/ -d '{"username": "root", "password": "pdso-training"}' | jq -r '.token' )
```
Note > Your engagement id and product id is probably not same with the above command, so you need to review your product id and engagement id by visiting DefectDojo. As you browse through an engagement or product, the id will be displayed in the url, eg: /engagement/3.

We can now upload the bandit’s scan output (bandit-output.json) to DefectDojo.
```sh
python3 upload-results.py --host dojo-acsrq8h9.lab.practical-devsecops.training --api_key $API_KEY --engagement_id 1 --product_id 1 --lead_id 1 --environment "Production" --result_file bandit-output.json --scanner "Bandit Scan"
```
```
**Output**
...
Successfully uploaded the results to DefectDojo
```
## Challenge: Upload ZAP results to DefectDojo manually
In this exercise, you will use the upload-results.py script to upload the ZAP Scan results to the DefectDojo.

To solve this challenge, please do the following:
- Explore the different features Dojo provides while keeping a note of URL changes in the address bar of your browser.
- Atleast visit the product page, engagement page and the test options in the Dojo portal
- The 500 error while uploading ZAP’s output is because of the wrong arguments used.
- Please read the documentation of Dojo to resolve the error https://defectdojo.github.io/django-DefectDojo/integrations/importing/.

> Note: Error 500 is caused by using the wrong format for ZAP in Defect Dojo. Link above suggests that a scan for ZAP should be used in a xml format and therefore this would remove the Error 500 and allow for an upload to Defect Dojo from GitLab

**Scan the production machine https://prod-acsrq8h9.lab.practical-devsecops.training with the help of the ZAP docker image owasp/zap2docker-stable:2.10.0, and save the results to /webapp/zap-output.xml**
Refer to the exercise How to Embed Zed Attack Proxy (ZAP) into GitLab, with output set to xml format -d -x zap-output.xml
```sh
docker run --user $(id -u):$(id -g) -w /zap -v $(pwd):/zap/wrk:rw --rm owasp/zap2docker-stable:2.10.0 zap-baseline.py -t https://prod-acsrq8h9.lab.practical-devsecops.training -d -x zap-output.xml
```
**Upload the ZAP scan results to Defect Dojo**
```sh
python3 upload-results.py --host dojo-acsrq8h9.lab.practical-devsecops.training --api_key $API_KEY --engagement_id 1 --product_id 1 --lead_id 1 --environment "Production" --result_file zap-output.xml --scanner "ZAP Scan"
```
